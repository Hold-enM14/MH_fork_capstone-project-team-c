# Table 1: Continuous Variable Summary
library(dplyr)

# Select the continuous variables
continuous_summary <- final_data %>%
  select(avg_chip_seconds, high_temp, low_temp, avg_temp, precipitation,
         dew_point, wind_speed, visibility, sea_level_pressure, aqi, pm10, pm25, no2, ozone, co) %>%
  summarise_all(list(
    mean = ~mean(., na.rm = TRUE),
    median = ~median(., na.rm = TRUE),
    sd = ~sd(., na.rm = TRUE),
    min = ~min(., na.rm = TRUE),
    max = ~max(., na.rm = TRUE)
  ))
continuous_summary



# Figure 1: Distribution of Average Finishing Times
library(ggplot2) # load plotting library
ggplot(final_data, aes(x = avg_chip_seconds / 3600)) + # convert from seconds to hours
  geom_histogram(bins = 20, fill = "steelblue", color = "black") + # create a histogram
  labs(title = "Distribution of Average Finishing Times", # generate labels
       x = "Average Finishing Time (hours)",
       y = "Frequency"
  )



# Figure 2: Overview of the Effect of Avg Temperature on Finishing Time by Marathon
ggplot(final_data, aes(x = avg_temp, y = avg_chip_seconds / 3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  facet_wrap(~ marathon, scales = "free_x") + # each marathon has own x-axis scale
  labs(title = "Overview of the Effect of Average Temperature on Finishing Time by Marathon",
       x = "Average Temperature (Â°F)",
       y = "Finishing Time (hours)"
  )



# Figure 3: Overview of the Relationship Between Air Quality and Finishing Time by Marathon
ggplot(final_data, aes(x = aqi, y = avg_chip_seconds / 3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  facet_wrap(~ marathon, scales = "free_x") + 
  labs(title = "Overview of the Relationship Between Air Quality and Finishing Time by Marathon",
       x = "Air Quality Index (AQI)",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "none")


final_data2 <- final_data |>
  dplyr::mutate(subgroup = tolower(as.character(subgroup))) |>
  dplyr::bind_rows(
    final_data |> dplyr::mutate(subgroup = "overall")
  ) |>
  dplyr::mutate(
    subgroup = factor(
      subgroup,
      levels = c("elite", "competitive", "average", "recreational", "slow", "overall")
    )
  )

final_data2 <- final_data2 %>% filter (!is.na(visibility))

# Figure 4: Overview of the Relationship Between Visibility and Finishing Time by Performance Group
ggplot(final_data2, aes(x = visibility, y = avg_chip_seconds / 3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(linetype=gender),method = "lm", se = FALSE, color = "black") +
  facet_wrap(~ subgroup, scales = "free_x") + 
  labs(title = "Overview of the Relationship Between Visibility and Finishing Time by Performance Subgroup",
       x = "Visibility (mi)",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "right")




# select only the numeric variables
numeric_vars <- final_data %>%
  select(avg_chip_seconds, avg_temp, precipitation, dew_point,
         wind_speed, visibility, sea_level_pressure,
         aqi, pm10, pm25, no2, ozone, co)

# create correlation matrix
cor_matrix <- cor(numeric_vars, use = "complete.obs")

# round the correlations
round(cor_matrix, 2)

library(corrplot)

cor_mat <- cor(numeric_vars, use = "complete.obs")

corrplot(
  cor_mat,
  method = "color",       # "circle", "square", "ellipse", etc.
  col = colorRampPalette(c("darkblue", "white", "red"))(200),
  addCoef.col = "black",  # add correlation coefficients
  tl.col = "black",       # text color
  tl.srt = 45             # rotate labels
)






final_data2 <- final_data |>
  dplyr::mutate(subgroup = tolower(as.character(subgroup))) |>
  dplyr::bind_rows(
    final_data |> dplyr::mutate(subgroup = "overall")
  ) |>
  dplyr::mutate(
    subgroup = factor(
      subgroup,
      levels = c("elite", "competitive", "average", "recreational", "slow", "overall")
    )
  )

final_data3 <- final_data2 %>% filter (main_pollutant=="PM2.5")

# Figure 5: Overview of the Relationship Between AQI/PM25 and Finishing Time by Performance Group
ggplot(final_data2, aes(x = aqi, y = avg_chip_seconds / 3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(linetype=gender),method = "lm", se = FALSE, color = "black") +
  facet_wrap(~ subgroup, scales = "free_x") + 
  labs(title = "Overview of the Relationship Between AQI and Finishing Time",
       x = "AQI",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "right")


ggplot(final_data2, aes(x = pm25, y = avg_chip_seconds / 3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(linetype=gender),method = "lm", se = FALSE, color = "black") +
  facet_wrap(~ subgroup, scales = "free_x") + 
  labs(title = "Overview of the Relationship Between PM2.5 and Finishing Time",
       x = "PM2.5",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "right")

ggplot(final_data2, aes(x = pm10, y = avg_chip_seconds / 3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(linetype=gender),method = "lm", se = FALSE, color = "black") +
  facet_wrap(~ subgroup, scales = "free_x") + 
  labs(title = "Overview of the Relationship Between PM10 and Finishing Time",
       x = "PM10",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "right")


ggplot(final_data3, aes(x = pm25, y = avg_chip_seconds / 3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(linetype=gender),method = "lm", se = FALSE, color = "black") +
  labs(title = "Overview of the Relationship Between PM2.5 and Finishing Time where PM2.5 is the primary pollutant",
       x = "PM2.5",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "right")




ggplot(final_data2, aes(x = pm25, y = avg_chip_seconds / 3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(linetype=gender),method = "lm", se = FALSE, color = "black") +
  labs(title = "Overview of the Relationship Between PM2.5 and Average Finishing Time",
       x = "PM2.5",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "right")



#SUPERSHOES
final_data2$year <- as.numeric(as.character(final_data2$year))
ggplot(final_data2, aes(x = year, y = avg_chip_seconds, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(linetype=gender),method = "lm", se = FALSE, color = "black") +
  facet_wrap(~ subgroup, scales = "free_x") + 
  geom_vline(xintercept = 2018, linetype = "dashed", color = "red", linewidth = 1) +  # vertical line
  labs(title = "Average Finishing Time Over the Years",
       x = "Year",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "right")


#SUPERSHOES
final_data2$year <- as.numeric(as.character(final_data2$year))
ggplot(final_data2, aes(x = year, y = avg_chip_seconds /3600, color = marathon)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(linetype=gender),method = "lm", se = FALSE, color = "black") +
  facet_wrap(subgroup ~ marathon, scales = "free_x") + 
  geom_vline(xintercept = 2018, linetype = "dashed", color = "red", linewidth = 1) +  # vertical line
  labs(title = "Average Finishing Time Over the Years",
       x = "Year",
       y = "Average Finishing Time (hours)"
  ) +
  theme(legend.position = "right")

